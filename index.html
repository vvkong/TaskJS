<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">    
    <title>IFE ECMAScript</title>
    <style>
        #email-input {
            box-sizing: border-box;
            width: 200px;
            height: 30px;
            margin: 0;
            padding: 2px;
            border: 1px solid rgb(216, 215, 215);
        }
        #email-sug-wrapper {
            box-sizing: border-box;
            width: 200px;
            margin: 0;
            padding: 0;
            display: none;
            list-style-type: none;
            border: 1px solid forestgreen;
        }
        #email-sug-wrapper > li {
            box-sizing: border-box;
            width: 100%;
            height: 35px;
            line-height: 35px;
            margin: 0;
            padding: 2px;
            overflow: hidden;
        }
        .email-sug {
        }
    </style>
</head>
<body> 
    <div class="wrapper">
        <input id="email-input" type="text">
        <ul id="email-sug-wrapper" class="email-sug"></ul>
    </div>
    <script>
        // 邮箱后缀List参考
        const postfixList = ['163.com', 'gmail.com', '126.com', 'qq.com', '263.net'];
        const elEmail = document.getElementById('email-input');
        const elSug = document.getElementById('email-sug-wrapper');

        elEmail.oninput = function() {
            let value = elEmail.value.trim();
            // let value = elEmail.value.replace(/(^\s*)|(\s*$)/g, "");
            if( !value || value === '' ) {
                elSug.style.display = 'none';
            } else {
                elSug.style.display = 'block';
                let noLi = elSug.childElementCount == 0;
                let atIdx = value.indexOf('@');
                let postStr = null;
                if( atIdx >= 0 ) {
                    postStr = value.substring(atIdx+1)
                    value = value.substr(0, atIdx);
                    if( postStr ) {
                        postStr = postStr.toLowerCase();
                    }
                }

                let noneMatch = true;
                if( postStr ) {
                    postfixList.forEach( (v) => { if( v.startsWith(postStr)) {noneMatch = false} })
                }
                let first = true;
                postfixList.forEach( (v, idx) => {
                    let li;
                    if( noLi ) {
                        li = document.createElement('li');
                        elSug.appendChild(li);
                    } else {
                        li = elSug.childNodes[idx];
                    }
                    if( noneMatch || v.startsWith(postStr) ) {
                        li.innerHTML = `${value}@${v}`;
                        li.style.display = "block";
                        if( first ) {
                            first = false;
                            li.style.backgroundColor = 'lightpink';
                        } else {
                            li.style.backgroundColor = 'white';
                        }
                    } else {
                        li.style.display = "none";
                        li.style.backgroundColor = 'white';
                    }
                });
            }
        }

        elEmail.onkeydown = function(e) {
            console.log(e.keyCode + ', ' + e.code);
            if( elSug.style.display === 'none' ) {
                return ;
            }
            let prePinkIdx = 0;
            for( let i=0; i<elSug.childElementCount; i++ ) {
                if( elSug.childNodes[i].style.backgroundColor === 'lightpink' ) {
                    prePinkIdx = i;
                    elSug.childNodes[i].style.backgroundColor = 'white';
                }
            }
            if( e.keyCode == 13 ) {
                elEmail.value = elSug.childNodes[prePinkIdx].innerHTML;
                elSug.style.display = 'none';
            } else if( e.keyCode == 38 ) {
                while( true ) {
                    prePinkIdx = prePinkIdx - 1 + elSug.childElementCount;
                    if( elSug.childNodes[prePinkIdx%elSug.childElementCount].style.display != 'none' ) {
                        break;
                    }
                }
            } else if( e.keyCode == 40 ) {
                while( true ) {
                    prePinkIdx++;
                    if( elSug.childNodes[prePinkIdx%elSug.childElementCount].style.display != 'none' ) {
                        break;
                    }
                }
            }
            elSug.childNodes[prePinkIdx%elSug.childElementCount].style.backgroundColor = 'lightpink';
        }
        elSug.onclick = function(e) {
            elEmail.value = e.target.innerHTML;
            elSug.style.display = 'none';
        }
        elSug.onmouseover = function(e) {
            for( el of elSug.childNodes ) {
                el.style.backgroundColor = 'white';
            }
            if( e.target.nodeName.toLowerCase() === 'li' ) {
                e.target.style.backgroundColor = 'lightpink'
            }
        }
        elSug.onmouseout = function(e) {
            e.target.style.backgroundColor = 'white';
        }
    </script>

</body>
</html>